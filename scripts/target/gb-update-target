#!/bin/bash

if [ -e /lib/gentoo/functions.sh ]
then
    source /lib/gentoo/functions.sh
elif [ -e /etc/init.d/functions.sh ]
then
    source /etc/init.d/functions.sh
fi

check_exit()
{
    RETVAL=$?
    if [ $RETVAL -ne 0 ]
    then
        if [ "$1" -ne 0 ]
        then
            eerror "$2 failed"
            exit $RETVAL
        else
            ewarn "$2 failed"
        fi
    fi
}

emerge --sync
check_exit 1 "Sync"

emerge --noreplace --oneshot sys-apps/portage
check_exit 1 "Updating portage"

emerge --verbose --keep-going=y --binpkg-changed-deps=n --update --deep --changed-use @world
check_exit 1 "Update"

emerge --depclean --with-bdeps=n --exclude="sys-kernel/linux-image"
check_exit 0 "Depclean"

eclean --deep packages
check_exit 0 "Clean packages"

# If portage tree is trimmed with PORTAGE_RSYNC_EXTRA_OPTS
# eclean will spam package names as they are
# unavailable in trimmed portage tree, so quiet it
eclean --quiet --deep distfiles
check_exit 0 "Clean distfiles"
